<html>
<head>
	<link rel="stylesheet" href="style.css">
</head>
<body>
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js"></script>
	<script src="https://unpkg.com/d3-graphviz@3.0.5/build/d3-graphviz.js"></script>
	<div id="inputArea">
		<label for="inputString">string to evaluate:</label><br>
		<input type="text" id="inputString"><br>
		<label for="initialString">starting state:</label><br>
		<input type="text" id="initialString" value="A"><br>
		<label for="acceptedString">accepting states:</label><br>
		<input type="text" id="acceptedString" value="C"><br>
		<br><br>
		<label for="machineDesc">machine to run:</label><br>
		<textarea id="machineDesc" rows="20" cols="30">
A 1 B
B 2 B
B 3 C
</textarea><br>
		<button onclick="process()">process!</button>
		<button onclick="animateMachine()">animate!</button>
	</div>
	<div id="finalResult">
		<div id="graph" style="text-align: center;"></div>
		resultHere
		
	</div>
	<script type="text/javascript">
		var graphObj = {};
		var graphString = "";

		function animateMachine() {
			process(); //make sure object is up to date
		}

		function process() {
			var inputString = document.getElementById("inputString").value;
			var machineDesc = document.getElementById("machineDesc").value;
			var acceptedString = document.getElementById("acceptedString").value;
			var initialString = document.getElementById("initialString").value;
			graphObj = {};
			graphString = "";
			setStartingState(initialString);
			acceptedStringToObj(acceptedString);
			graphStrToObj(machineDesc);
			console.log(graphObj);
		}
		
		function setStartingState(initialString) {
			graphObj.startState__ = initialString
		}
		
		function acceptedStringToObj(acceptStr) {
			var acceptArr = acceptStr.split(/[\s,]/).filter(element => element);
			console.log(acceptArr);
			acceptArr.forEach((node, index, arr) => {
				graphObj[node] = graphObj[node] || {}
				graphObj[node].isAcceptState = true;
			})
		}
		
		function graphStrToObj(graphStr){
			var graphArr = graphStr.split(/\r?\n/).filter(element => element);
			graphArr.forEach(graphLineToObj);
			graphObjToDOT(graphObj);
			console.log(graphString)
			d3.select("#graph").graphviz().renderDot(graphString);
		}
		
		function graphLineToObj(graphLine, index, arr) {
			var lineArr = graphLine.split(" ").filter(element => element);
			//console.log(lineArr);
			/*if (lineArr[0].startsWith("!")){
				lineArr[0]=lineArr[0].substring(1);
				graphObj[lineArr[0]].isAcceptState = true;
			}*/
			graphObj[lineArr[0]] = graphObj[lineArr[0]] || {}
			graphObj[lineArr[0]].edges = graphObj[lineArr[0]].edges || {}
			graphObj[lineArr[0]].edges[lineArr[1]]=lineArr[2]
			graphObj[lineArr[2]] = graphObj[lineArr[2]] || {}
		}
		
		function graphObjToDOT(graphObj){
			graphString = `digraph {__startState__ [label= "", shape=none,height=.0,width=.0]\n__startState__ -> ${graphObj.startState__}\n`;
			for (node in graphObj){
				if(graphObj[node].isAcceptState){
					graphString = `${graphString}${node}[shape=doublecircle]\n`;
				}
				for (edge in graphObj[node].edges){
					console.log(node);
					graphString = `${graphString} ${node} ->  ${graphObj[node].edges[edge]} [label="  ${edge}"] ;\n`;
				}
			}
			graphString = graphString + "}";
		}
		
		d3.select("#graph").graphviz().renderDot('digraph  {a -> b[label=3]}');
		
		
		
	</script>
	
</body>
</html>